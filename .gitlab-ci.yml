variables:
  # Not normally needed, but may be if some script uses `apt-get install`.
  DEBIAN_FRONTEND: noninteractive
  # Locale settings do not affect the build, but might affect tests.
  LC_ALL: C

  CI_REGISTRY_IMAGE: registry.gitlab.isc.org/isc-projects/images/bind9

  GIT_DEPTH: 1
  BUILD_PARALLEL_JOBS: 6

  CFLAGS_COMMON: -fno-omit-frame-pointer -fno-optimize-sibling-calls -O1 -g -Wall -Wextra 

  TARBALL_EXTENSION: xz

  AM_COLOR_TESTS: always

  # In multithreaded unit tests, abort on the first failure
  CMOCKA_TEST_ABORT: 1

  # Disable pytest's "cacheprovider" plugin to prevent it from creating
  # cross-testrun files as there is no need to use that feature in CI.
  PYTEST_ADDOPTS: "-p no:cacheprovider"

stages:
  - autoconf
  - precheck
  - build
  - unit
  - system
  - performance
  - docs
  - push
  - postcheck
  - release

### Runner Tag Templates

.linux-amd64: &linux_amd64
  tags:
    - linux
    - amd64
    - pspacek8720

### Docker Image Templates

# Debian

.debian-stretch-amd64: &debian_stretch_amd64_image
  image: "$CI_REGISTRY_IMAGE:debian-stretch-amd64"
  <<: *linux_amd64

.debian-buster-amd64: &debian_buster_amd64_image
  image: "$CI_REGISTRY_IMAGE-staging:debian-buster-amd64"
  <<: *linux_amd64

.debian-bullseye-amd64: &debian_bullseye_amd64_image
  image: "$CI_REGISTRY_IMAGE-staging:debian-bullseye-amd64"
  <<: *linux_amd64

.debian-sid-amd64: &debian_sid_amd64_image
  image: "$CI_REGISTRY_IMAGE:debian-sid-amd64"
  <<: *linux_amd64

# Base image
# This is a meta image that is used as a base for non-specific jobs

.base: &base_image
  <<: *debian_bullseye_amd64_image

### Job Templates

.setup_interfaces: &setup_interfaces
    - echo -e "\e[0Ksection_start:$(date +%s):setup_interfaces[collapsed=true]\r\e[0KSetup networking"
    - if [ "$(id -u)" -eq "0" ]; then
        sh -x bin/tests/system/ifconfig.sh up;
      else
        sudo sh -x bin/tests/system/ifconfig.sh up;
      fi
    - echo -e "\e[0Ksection_end:$(date +%s):setup_interfaces\r\e[0K"

### Job Definitions

# Respdiff test

respdiff:
  <<: *base_image
  stage: system
  variables:
    CC: gcc
    CFLAGS: "${CFLAGS_COMMON} -Og"
    BIND_BASELINE_VERSION: v9_11_24
    MAX_DISAGREEMENTS_PERCENTAGE: "0.5"
  script:
    - echo -e "\e[0Ksection_start:$(date +%s):build1[collapsed=true]\r\e[0KBuild version under test"
    - autoreconf -fi
    - ./configure
    - make -j${BUILD_PARALLEL_JOBS:-1}
    - echo -e "\e[0Ksection_end:$(date +%s):build1\r\e[0K"
    - *setup_interfaces
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.isc.org/isc-private/bind-qa.git
    - git clone --branch "${BIND_BASELINE_VERSION}" --depth 1 https://gitlab.isc.org/isc-projects/bind9.git refbind
    - echo -e "\e[0Ksection_start:$(date +%s):build2[collapsed=true]\r\e[0KBuild reference version"
    - cd refbind/
    - autoreconf -fi
    - ./configure
    - make -j${BUILD_PARALLEL_JOBS:-1}
    - echo -e "\e[0Ksection_end:$(date +%s):build2\r\e[0K"
    - cd ../bind-qa/bind9/respdiff
    - truncate 100k_mixed.txt --size=518332  # 20000 lines
    - bash respdiff.sh -q "${PWD}/100k_mixed.txt" -c 3 -w "${PWD}/rspworkdir" "${CI_PROJECT_DIR}/refbind" "${CI_PROJECT_DIR}"
  artifacts:
    paths:
      - refbind
      - bind-qa/bind9/respdiff
    untracked: true
    expire_in: "1 day"
    when: always
  timeout: 2h
